- name: install apt-transport-https
  sudo: True
  apt: name=apt-transport-https
- name: add fastd repo
  sudo: True
  apt_repository: repo="deb https://repo.universe-factory.net/debian/ sid main"
  # there are only packages in 'sid' there
  when: ansible_distribution == 'Debian'
- name: add fastd repo key
  apt_key: id=6664E7BDA6B669881EC52E7516EF3F64CB201D9C url=https://sks-keyservers.net/pks/lookup?op=get&search=0x16EF3F64CB201D9C state=present
- name: install fastd
  sudo: True
  apt: name=fastd update_cache=yes
- name: create fastd config dirs
  file: dest=/etc/fastd/{{ item.name }} state=directory
  with_items: fastdHosts[ansible_hostname].configs
  tags: [ fastd-config ]
- name: write fastd keys # should not be logged
  lineinfile: dest=/etc/fastd/{{ item.name }}/secret.conf create=yes mode=0600 line='secret "{{ fastd_secret }}";'
  with_items: fastdHosts[ansible_hostname].configs
  tags: [ fastd-config ]
- name: write fastd configs
  template: src=fastd.conf.j2 dest=/etc/fastd/{{ item.name }}/fastd.conf
  with_items: fastdHosts[ansible_hostname].configs
  tags: [ fastd-config ]
  notify: restart fastd
- name: write fastd blacklist.sh
  template: src=blacklist.sh.j2 dest=/etc/fastd/{{ item.name }}/blacklist.sh mode=750
  with_items: fastdHosts[ansible_hostname].configs
  tags: [ fastd-config ]
